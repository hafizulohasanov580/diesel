<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DIESEL CENTER - ULTIMATE</title>
    
    <!-- Firebase (–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –í—Ö–æ–¥) -->
    <script type="module" src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>

    <!-- PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --p: #f97316; --bg: #0f172a; --card: #1e293b; --txt: #f8fafc; --brd: #475569; --s: #22c55e; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--txt); overflow: hidden; font-size: 12px; }

        /* –£–±–∏—Ä–∞–µ–º —Å—Ç—Ä–µ–ª–∫–∏ —É —Ü–∏—Ñ—Ä */
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; border:none; border-bottom: 1px solid var(--brd); background: transparent; color: var(--p); font-weight: bold; text-align: center; outline: none; }

        /* –≠–ö–†–ê–ù–´ */
        .screen { position: fixed; inset: 0; background: #000; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px; }
        .hidden { display: none !important; }

        .box { background: var(--card); padding: 30px; border-radius: 16px; border: 1px solid var(--p); text-align: center; width: 320px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .logo { font-size: 24px; font-weight: 900; color: #fff; margin-bottom: 20px; display: block; }
        .logo span { color: var(--p); }

        /* –ö–ù–û–ü–ö–ò */
        .btn { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 14px; transition: 0.2s; }
        .btn-g { background: #fff; color: #000; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-l { background: #334155; color: #fff; border: 1px solid var(--brd); }
        .btn-m { background: var(--p); color: #000; }
        .btn-link { background: none; color: #94a3b8; font-size: 11px; margin-top: 10px; text-decoration: underline; cursor: pointer; border: none; }

        input.pin-in { background: #0f172a; border: 1px solid var(--brd); padding: 10px; color: #fff; border-radius: 8px; font-size: 18px; letter-spacing: 5px; text-align: center; width: 100%; margin-bottom: 10px; }

        /* –ò–ù–¢–ï–†–§–ï–ô–° –¢–ê–ë–õ–ò–¶–´ */
        .header { background: #000; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--p); position: sticky; top: 0; z-index: 500; }
        .lang-s { display: flex; gap: 5px; }
        .l-btn { background: #334155; padding: 4px 8px; border-radius: 4px; border: none; color: #fff; cursor: pointer; font-size: 10px; }
        .l-btn.active { background: var(--p); color: #000; font-weight: bold; }

        .controls { padding: 10px; display: flex; gap: 8px; background: var(--card); border-bottom: 1px solid var(--brd); }
        input.txt-in { background: #0f172a; border: 1px solid var(--brd); padding: 8px; color: #fff; border-radius: 4px; flex: 2; }
        select { background: #0f172a; color: #fff; border: 1px solid var(--brd); padding: 8px; border-radius: 4px; }

        .view { width: 100vw; height: calc(100vh - 130px); overflow: auto; }
        table { border-collapse: separate; border-spacing: 0; width: 100%; table-layout: fixed; }
        
        thead th { position: sticky; top: 0; background: #000; z-index: 50; height: 35px; border-bottom: 1px solid var(--p); color: #94a3b8; font-size: 10px; }
        .cw { position: sticky; left: 0; z-index: 60; width: 140px; background: #111; padding: 8px; border-right: 2px solid var(--p); }
        .cd { width: calc((100vw - 200px) / 31); min-width: 26px; text-align: center; border-right: 1px solid #333; }
        .ct { width: 60px; position: sticky; right: 0; background: #000; z-index: 40; border-left: 2px solid var(--p); text-align: center; color: var(--s); font-weight: bold; }

        .sq-h { width: 22px; height: 22px; border: 1px solid var(--brd); border-radius: 4px; margin: 2px auto; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 10px; }
        .sq-h.on { background: var(--s); color: #000; border: none; } .sq-h.on::after { content: '‚úì'; }
        .sq-a { width: 20px; height: 14px; border: 1px dashed var(--p); border-radius: 10px; margin: 2px auto; cursor: pointer; font-size: 8px; color: var(--p); display: flex; align-items: center; justify-content: center; }
        .sq-a.on { background: var(--p); color: #000; border-style: solid; font-weight: bold; }
    </style>
</head>
<body>

<!-- 1. –≠–ö–†–ê–ù –í–´–ë–û–†–ê –í–•–û–î–ê -->
<div id="screen-login" class="screen">
    <div class="box">
        <div class="logo">DIESEL <span>CENTER</span></div>
        <p style="color:#94a3b8; margin-bottom:20px" id="lbl-welcome">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –≤—Ö–æ–¥–∞</p>
        
        <button class="btn btn-g" id="btn-google">
            <span style="font-size:18px">G</span> <span id="lbl-g">Google (–û–±–ª–∞–∫–æ)</span>
        </button>
        
        <button class="btn btn-l" id="btn-local" onclick="authLocal()">
            üíæ <span id="lbl-l">–õ–æ–∫–∞–ª—å–Ω–æ (–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ)</span>
        </button>
    </div>
</div>

<!-- 2. –≠–ö–†–ê–ù PIN-–ö–û–î–ê -->
<div id="screen-pin" class="screen hidden">
    <div class="box">
        <div class="logo">üîê</div>
        <h3 id="pin-title" style="margin:0 0 15px 0">–í–≤–µ–¥–∏—Ç–µ PIN</h3>
        <input type="tel" id="pin-input" class="pin-in" maxlength="4" placeholder="****">
        <button class="btn btn-m" onclick="checkPin()" id="btn-enter">–í–û–ô–¢–ò</button>
        <button class="btn-link" onclick="forgotPin()" id="btn-forgot">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</button>
    </div>
</div>

<!-- 3. –ì–õ–ê–í–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï -->
<div id="screen-app" class="hidden">
    <div class="header">
        <div class="logo" style="font-size:18px">DIESEL <span>PRO</span></div>
        <div class="lang-s">
            <button class="l-btn active" onclick="setLang('ru')">RU</button>
            <button class="l-btn" onclick="setLang('tj')">TJ</button>
            <button class="l-btn" onclick="setLang('en')">EN</button>
        </div>
        <button onclick="logout()" style="background:#ef4444; color:#fff; border:none; padding:5px 10px; border-radius:4px; font-weight:bold; margin-left:10px; cursor:pointer">EXIT</button>
    </div>

    <div class="controls">
        <input type="text" id="nw" class="txt-in" placeholder="–ò–º—è –º–∞—Å—Ç–µ—Ä–∞">
        <button onclick="addW()" class="l-btn" style="background:var(--p); color:#000; font-weight:bold; font-size:12px; padding:8px 15px">OK</button>
        <button onclick="genPDF()" class="l-btn" style="background:#fff; color:#000; font-weight:bold; font-size:12px; padding:8px 15px">PDF</button>
    </div>
    
    <div class="controls" style="padding-top:0">
        <select id="mS" onchange="render()" style="flex:1"></select>
        <select id="yS" onchange="render()" style="flex:1"></select>
    </div>

    <div class="view">
        <table>
            <thead>
                <tr id="hRow">
                    <th class="cw" id="th-m">–ú–ê–°–¢–ï–†</th>
                    <th class="ct" id="th-t">–ò–¢–û–ì–û</th>
                </tr>
            </thead>
            <tbody id="tBody"></tbody>
        </table>
    </div>
</div>

<script type="module">
    // --- FIREBASE SETUP (–í–°–¢–ê–í–¨ –°–Æ–î–ê –°–í–û–ò –î–ê–ù–ù–´–ï) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    // üî¥ –í–ù–ò–ú–ê–ù–ò–ï: –°–ö–û–ü–ò–†–£–ô –ö–û–ù–§–ò–ì –ò–ó –°–í–û–ï–ô –ö–û–ù–°–û–õ–ò FIREBASE
    const firebaseConfig = {
        apiKey: "–¢–í–û–ô_API_KEY",
        authDomain: "–¢–í–û–ô_PROJECT.firebaseapp.com",
        projectId: "–¢–í–û–ô_PROJECT_ID",
        storageBucket: "–¢–í–û–ô_BUCKET",
        messagingSenderId: "–¢–í–û–ô_SENDER_ID",
        appId: "–¢–í–û–ô_APP_ID"
    };

    let app, auth, db, provider;
    try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        provider = new GoogleAuthProvider();
    } catch(e) { console.log("–†–∞–±–æ—Ç–∞–µ–º –±–µ–∑ Firebase (–õ–æ–∫–∞–ª—å–Ω–æ)"); }

    // --- –õ–û–ì–ò–ö–ê ---
    let mode = 'local'; // 'local' or 'cloud'
    let userUid = 'local_user';
    let pinCode = null;
    let workers = [];
    let curL = 'ru';

    const dict = {
        ru: { m: "–ú–ê–°–¢–ï–†", t: "–ò–¢–û–ì–û", h: "–ß–∞—Å—ã", r: "–°—Ç–∞–≤–∫–∞", ph: "–ò–º—è –º–∞—Å—Ç–µ—Ä–∞", del: "–£–î–õ", adv: "–ê–≤–∞–Ω—Å:", pinT: "–í–≤–µ–¥–∏—Ç–µ PIN", pinN: "–ü—Ä–∏–¥—É–º–∞–π—Ç–µ PIN (4 —Ü–∏—Ñ—Ä—ã)", forg: "–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å?", resetW: "–í–ù–ò–ú–ê–ù–ò–ï! –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?", qh: "–ß–∞—Å—ã (0-24):" },
        tj: { m: "–£–°–¢–û", t: "“∂–ê–™–ú", h: "–°–æ–∞—Ç", r: "–ù–∞—Ä—Ö", ph: "–ù–æ–º–∏ —É—Å—Ç–æ", del: "–ù–ï–°–¢", adv: "–ê–≤–∞–Ω—Å:", pinT: "–†–∞–º–∑—Ä–æ –≤–æ—Ä–∏–¥ –∫—É–Ω–µ–¥", pinN: "–†–∞–º–∑–∏ –Ω–∞–≤ (4 —Ä–∞“õ–∞–º)", forg: "–†–∞–º–∑—Ä–æ —Ñ–∞—Ä–æ–º”Ø—à –∫–∞—Ä–¥–µ–¥?", resetW: "–î–∏“õ“õ–∞—Ç! “≤–∞–º–∞ –º–∞—ä–ª—É–º–æ—Ç –Ω–µ—Å—Ç –º–µ—à–∞–≤–∞–¥. –î–∞–≤–æ–º –º–µ–¥–∏“≥–µ–¥?", qh: "–°–æ–∞—Ç (0-24):" },
        en: { m: "MASTER", t: "TOTAL", h: "Hrs", r: "Rate", ph: "Name", del: "DEL", adv: "Adv:", pinT: "Enter PIN", pinN: "Create PIN", forg: "Forgot PIN?", resetW: "WARNING! Local data will be lost. Continue?", qh: "Hours (0-24):" }
    };

    // 1. –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø
    window.authLocal = function() {
        mode = 'local';
        userUid = 'local_device';
        checkPinSetup();
    }

    if(auth) {
        document.getElementById('btn-google').onclick = () => {
            signInWithPopup(auth, provider).then((res) => {
                mode = 'cloud';
                userUid = res.user.uid;
                checkPinSetup();
            }).catch(e => alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + e.message));
        };
    }

    async function checkPinSetup() {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º PIN
        if(mode === 'local') {
            pinCode = localStorage.getItem('mp_pin');
        } else {
            // –ò–∑ –æ–±–ª–∞–∫–∞
            const docSnap = await getDoc(doc(db, "users", userUid));
            if(docSnap.exists()) pinCode = docSnap.data().pin;
        }

        document.getElementById('screen-login').classList.add('hidden');
        document.getElementById('screen-pin').classList.remove('hidden');
        
        const tit = document.getElementById('pin-title');
        if(!pinCode) tit.innerText = dict[curL].pinN;
        else tit.innerText = dict[curL].pinT;
    }

    window.checkPin = async function() {
        const val = document.getElementById('pin-input').value;
        if(!pinCode) {
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
            if(val.length < 4) return alert("–ú–∏–Ω–∏–º—É–º 4 —Ü–∏—Ñ—Ä—ã");
            pinCode = val;
            if(mode === 'local') localStorage.setItem('mp_pin', val);
            else await setDoc(doc(db, "users", userUid), { pin: val }, { merge: true });
            loadData();
        } else {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º
            if(val === pinCode) loadData();
            else alert("–ù–µ–≤–µ—Ä–Ω–æ!");
        }
    }

    window.forgotPin = function() {
        if(mode === 'local') {
            if(confirm(dict[curL].resetW)) {
                localStorage.clear();
                location.reload();
            }
        } else {
            alert("–ü–µ—Ä–µ–∑–∞–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Google, —á—Ç–æ–±—ã —Å–±—Ä–æ—Å–∏—Ç—å PIN");
            logout();
        }
    }

    window.logout = function() {
        if(auth) auth.signOut();
        location.reload();
    }

    // 2. –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–•
    async function loadData() {
        document.getElementById('screen-pin').classList.add('hidden');
        document.getElementById('screen-app').classList.remove('hidden');
        
        if(mode === 'local') {
            workers = JSON.parse(localStorage.getItem('mp_data')) || [];
            render();
        } else {
            const docSnap = await getDoc(doc(db, "data", userUid));
            if(docSnap.exists()) workers = docSnap.data().w || [];
            render();
        }
    }

    async function saveData() {
        if(mode === 'local') {
            localStorage.setItem('mp_data', JSON.stringify(workers));
        } else {
            await setDoc(doc(db, "data", userUid), { w: workers });
        }
    }

    // 3. –ò–ù–¢–ï–†–§–ï–ô–° –ò –Ø–ó–´–ö–ò
    const months = ["–Ø–Ω–≤","–§–µ–≤","–ú–∞—Ä","–ê–ø—Ä","–ú–∞–π","–ò—é–Ω","–ò—é–ª","–ê–≤–≥","–°–µ–Ω","–û–∫—Ç","–ù–æ—è","–î–µ–∫"];
    const mS = document.getElementById('mS'), yS = document.getElementById('yS');
    months.forEach((m,i)=>mS.add(new Option(m,i,false,i===new Date().getMonth())));
    for(let y=2025;y<=2028;y++) yS.add(new Option(y,y,false,y===new Date().getFullYear()));

    window.setLang = function(l) {
        curL = l;
        document.getElementById('th-m').innerText = dict[l].m;
        document.getElementById('th-t').innerText = dict[l].t;
        document.getElementById('nw').placeholder = dict[l].ph;
        document.getElementById('btn-forgot').innerText = dict[l].forg;
        render();
    }

    window.addW = function() {
        let n = document.getElementById('nw').value.trim();
        if(n) { workers.push({n:n, r:170, d:{}}); saveData(); render(); document.getElementById('nw').value=''; }
    }

    window.render = function() {
        const y=yS.value, m=mS.value, days=new Date(y, parseInt(m)+1, 0).getDate();
        const hr = document.getElementById('hRow');
        while(hr.children.length > 2) hr.removeChild(hr.children[1]);
        for(let d=1; d<=days; d++) {
            let th = document.createElement('th'); th.className='cd'; th.innerText=d;
            hr.insertBefore(th, hr.children[d]);
        }

        const tb = document.getElementById('tBody'); tb.innerHTML = '';
        workers.forEach((w, idx) => {
            let row = document.createElement('tr');
            let html = `<td class="cw">
                <b>${w.n}</b>
                <div style="font-size:10px; color:#94a3b8">${dict[curL].h}: <span id="th_${idx}">0</span></div>
                <div style="font-size:10px; color:#94a3b8">${dict[curL].r}: <input type="number" value="${w.r}" oninput="updR(${idx},this.value)"></div>
                <div onclick="delW(${idx})" style="color:#ef4444; font-size:9px; cursor:pointer; margin-top:3px">${dict[curL].del}</div>
            </td>`;

            let total = 0, hours = 0;
            for(let d=1; d<=days; d++) {
                let k = `${y}_${m}_${d}`;
                let h = w.d[k]?.h || 0;
                let a = w.d[k]?.a || 0;
                
                hours += h;
                total += (h * (w.r/8)) - a;

                html += `<td class="cd">
                    <div class="sq-h ${h==8?'on':''}" onclick="setH(${idx},'${k}',8)" oncontextmenu="setCus(event,${idx},'${k}')">${(h>0&&h!=8)?h:''}</div>
                    <div class="sq-a ${a>0?'on':''}" onclick="setA(${idx},'${k}')">${a>0?a:'$'}</div>
                </td>`;
            }
            html += `<td class="ct">${Math.round(total).toLocaleString()}</td>`;
            row.innerHTML = html;
            tb.appendChild(row);
            
            // –û—Ç–ª–æ–∂–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Å–æ–≤ (–ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞)
            setTimeout(() => { 
                const el = document.getElementById(`th_${idx}`);
                if(el) el.innerText = hours; 
            }, 0);
        });
    }

    window.updR = (i,v) => { workers[i].r = v; saveData(); render(); }
    window.delW = (i) => { if(confirm('?')) { workers.splice(i,1); saveData(); render(); } }
    
    window.setH = (i,k,v) => { 
        if(!workers[i].d[k]) workers[i].d[k] = {};
        workers[i].d[k].h = (workers[i].d[k].h === 8 ? 0 : 8);
        saveData(); render();
    }
    
    window.setCus = (e,i,k) => {
        e.preventDefault();
        let v = prompt(dict[curL].qh);
        if(v!==null) {
            if(!workers[i].d[k]) workers[i].d[k] = {};
            workers[i].d[k].h = parseInt(v)||0;
            saveData(); render();
        }
    }

    window.setA = (i,k) => {
        let v = prompt(dict[curL].adv);
        if(v!==null) {
            if(!workers[i].d[k]) workers[i].d[k] = {};
            workers[i].d[k].a = parseFloat(v)||0;
            saveData(); render();
        }
    }

    // --- PDF ---
    function tr(s) {
        const m = {'–ê':'A','–∞':'a','–ë':'B','–±':'b','–î':'D','–¥':'d','–ï':'E','–µ':'e','–Å':'Yo','—ë':'yo','–ñ':'Zh','–∂':'zh','–ó':'Z','–∑':'z','–ò':'I','–∏':'i','–ô':'J','–π':'j','–ö':'K','–∫':'k','–õ':'L','–ª':'l','–ú':'M','–º':'m','–ù':'N','–Ω':'n','–û':'O','–æ':'o','–ü':'P','–ø':'p','–†':'R','—Ä':'r','–°':'S','—Å':'s','–¢':'T','—Ç':'t','–£':'U','—É':'u','–§':'F','—Ñ':'f','–•':'Kh','—Ö':'kh','–¶':'Ts','—Ü':'ts','–ß':'Ch','—á':'ch','–®':'Sh','—à':'sh','–©':'Sch','—â':'sch','–´':'Y','—ã':'y','–≠':'E','—ç':'e','–Æ':'Yu','—é':'yu','–Ø':'Ya','—è':'ya','“∑':'j','“∂':'J','“õ':'q','“ö':'Q','“≥':'h','“≤':'H','”Ø':'u','”Æ':'U','“ì':'gh','“í':'Gh'};
        return s.split('').map(c => m[c] || c).join('');
    }

    window.genPDF = function() {
        const doc = new jspdf.jsPDF();
        doc.text("DIESEL CENTER REPORT", 105, 15, {align:"center"});
        let rows = [];
        // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
        workers.forEach((w, idx) => {
            // –†–∞—Å—á–µ—Ç –¥–ª—è PDF
            const y=yS.value, m=mS.value, days=new Date(y, parseInt(m)+1, 0).getDate();
            let total = 0, hours = 0;
            for(let d=1; d<=days; d++) {
                let k = `${y}_${m}_${d}`;
                let h = w.d[k]?.h || 0;
                let a = w.d[k]?.a || 0;
                hours += h;
                total += (h * (w.r/8)) - a;
            }
            rows.push([tr(w.n), hours, Math.round(total) + " TJS"]);
        });
        doc.autoTable({ startY: 25, head: [['Master', 'Hours', 'Total']], body: rows });
        doc.save("Report.pdf");
    }

    // –°—Ç–∞—Ä—Ç
    setLang('ru');
</script>
</body>
</html>