<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DIESEL CENTER - ULTIMATE</title>
    
    <script type="module" src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { 
            --p: #ff6b35; 
            --bg: #0a0e27; 
            --card: #141829; 
            --txt: #e8eef5; 
            --brd: #2a3f5f; 
            --s: #00d4ff; 
            --accent: #ffa500;
            --danger: #ff4757;
        }
        body.light { 
            --bg: #f5f7fa; 
            --card: #ffffff; 
            --txt: #1a1f3a; 
            --brd: #d0d8e8; 
            --s: #0088cc;
        }
        * { 
            box-sizing: border-box; 
            font-family: 'Courier New', 'Roboto', sans-serif; 
            transition: 0.3s ease; 
        }
        body { 
            margin: 0; 
            background: linear-gradient(135deg, var(--bg) 0%, #0f1628 100%); 
            color: var(--txt); 
            overflow: hidden; 
            font-size: 12px;
            letter-spacing: 0.5px;
        }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { 
            -moz-appearance: textfield; 
            border: none; 
            border-bottom: 2px solid var(--p); 
            background: transparent; 
            color: var(--p); 
            font-weight: bold; 
            width: 50px; 
            text-align: center; 
            outline: none;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .screen { 
            position: fixed; 
            inset: 0; 
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%); 
            z-index: 1000; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            gap: 15px;
            backdrop-filter: blur(10px);
        }
        .hidden { display: none !important; }
        .box { 
            background: linear-gradient(135deg, var(--card) 0%, #1a2847 100%);
            padding: 40px; 
            border-radius: 12px; 
            border: 2px solid var(--p); 
            text-align: center; 
            width: 380px; 
            box-shadow: 0 20px 60px rgba(255, 107, 53, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }
        .box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--p), transparent);
        }
        .logo { 
            font-size: 32px; 
            font-weight: 900; 
            color: var(--txt); 
            margin-bottom: 10px;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        .logo span { 
            color: var(--p);
            text-shadow: 0 0 10px rgba(255, 107, 53, 0.5);
        }
        .logo-sub {
            font-size: 11px;
            color: var(--s);
            margin-bottom: 25px;
            letter-spacing: 3px;
            opacity: 0.8;
        }
        .btn { 
            width: 100%; 
            padding: 14px; 
            border-radius: 8px; 
            border: none; 
            font-weight: bold; 
            cursor: pointer; 
            margin-top: 12px; 
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3); }
        .btn-white { 
            background: #fff; 
            color: #000; 
            border: 2px solid #fff;
        }
        .btn-white:hover { background: transparent; color: #fff; }
        .btn-dark { 
            background: linear-gradient(135deg, #2a3f5f 0%, #1a2847 100%);
            color: #fff; 
            border: 2px solid var(--brd);
        }
        .btn-dark:hover { border-color: var(--p); color: var(--p); }
        .btn-orange { 
            background: linear-gradient(135deg, var(--p) 0%, #ff8c42 100%);
            color: #fff;
            box-shadow: 0 10px 25px rgba(255, 107, 53, 0.3);
        }
        .btn-orange:hover { transform: translateY(-3px); box-shadow: 0 15px 35px rgba(255, 107, 53, 0.4); }
        .header { 
            background: linear-gradient(90deg, var(--card) 0%, #1a2847 100%);
            padding: 12px 18px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 3px solid var(--p);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        .lang-s { display: flex; gap: 8px; }
        .l-btn { 
            background: var(--brd); 
            padding: 8px 12px; 
            border-radius: 6px; 
            border: 2px solid transparent;
            color: #fff; 
            cursor: pointer; 
            font-size: 11px; 
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.2s ease;
        }
        .l-btn:hover { border-color: var(--p); }
        .l-btn.active { 
            background: var(--p);
            border-color: var(--p);
            color: #fff;
            box-shadow: 0 0 10px rgba(255, 107, 53, 0.5);
        }
        .controls { 
            padding: 14px; 
            display: flex; 
            gap: 10px; 
            background: linear-gradient(90deg, var(--card) 0%, #1a2847 100%);
            border-bottom: 2px solid var(--brd);
        }
        .txt-in { 
            background: var(--bg); 
            border: 2px solid var(--brd); 
            padding: 10px 14px; 
            color: var(--txt); 
            border-radius: 6px; 
            flex: 2; 
            outline: none;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .txt-in:focus { border-color: var(--p); box-shadow: 0 0 10px rgba(255, 107, 53, 0.2); }
        .view { 
            width: 100vw; 
            height: calc(100vh - 140px); 
            overflow: auto;
            background: var(--bg);
        }
        table { 
            border-collapse: separate; 
            border-spacing: 0; 
            width: 100%;
            background: var(--card);
        }
        thead th { 
            position: sticky; 
            top: 0; 
            background: linear-gradient(90deg, var(--card) 0%, #1a2847 100%);
            z-index: 50; 
            padding: 12px 8px; 
            border-bottom: 2px solid var(--p); 
            color: var(--s);
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .cw { 
            position: sticky; 
            left: 0; 
            z-index: 60; 
            width: 160px; 
            background: linear-gradient(90deg, var(--card) 0%, #1a2847 100%);
            padding: 12px; 
            border-right: 3px solid var(--p); 
            font-weight: bold;
            color: var(--s);
        }
        .cd { 
            width: 40px; 
            text-align: center; 
            border-right: 1px solid var(--brd);
            padding: 8px 4px;
        }
        .ct { 
            width: 90px; 
            position: sticky; 
            right: 0; 
            background: linear-gradient(90deg, var(--card) 0%, #1a2847 100%);
            z-index: 40; 
            border-left: 3px solid var(--p); 
            text-align: center; 
            color: var(--s); 
            font-weight: 900; 
            font-size: 14px;
            padding: 8px;
            text-transform: uppercase;
        }
        .sq-h { 
            width: 28px; 
            height: 28px; 
            border: 2px solid var(--brd); 
            border-radius: 6px; 
            margin: 4px auto; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            background: var(--bg); 
            font-size: 12px; 
            color: var(--p); 
            font-weight: bold;
            transition: all 0.2s ease;
        }
        .sq-h:hover { border-color: var(--p); box-shadow: 0 0 8px rgba(255, 107, 53, 0.3); }
        .sq-h.on { 
            background: linear-gradient(135deg, var(--s) 0%, #00a8cc 100%);
            color: var(--card); 
            border: 2px solid var(--s);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.4);
        }
        .sq-h.on::after { content: '‚úì'; }
        .sq-a { 
            width: 26px; 
            height: 20px; 
            border: 2px dashed var(--p); 
            border-radius: 8px; 
            margin: 4px auto; 
            cursor: pointer; 
            font-size: 9px; 
            color: var(--p); 
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-weight: bold;
            transition: all 0.2s ease;
        }
        .sq-a:hover { border-style: solid; }
        .sq-a.on { 
            background: var(--p); 
            color: #fff; 
            border-style: solid;
            box-shadow: 0 0 10px rgba(255, 107, 53, 0.4);
        }
    </style>
</head>
<body id="mainBody">

<div id="screen-login" class="screen">
    <div class="box">
        <div class="logo">DIESEL <span>CENTER</span></div>
        <button class="btn btn-white" id="btn-google">G Google (–û–±–ª–∞–∫–æ)</button>
        <button class="btn btn-dark" onclick="authLocal()">üíæ –¢–æ–ª—å–∫–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</button>
    </div>
</div>

<div id="screen-pin" class="screen hidden">
    <div class="box">
        <div class="logo">üîê</div>
        <h3 id="pin-title">–í–≤–µ–¥–∏—Ç–µ –ü–ò–ù</h3>
        <input type="tel" id="pin-input" style="width:100%; font-size:28px; text-align:center; padding:10px; border-radius:8px; border:1px solid var(--brd); background:var(--bg); color:var(--txt);" maxlength="4">
        <button class="btn btn-orange" onclick="checkPin()" id="btn-login-text">–í–•–û–î</button>
    </div>
</div>

<div id="screen-app" class="hidden">
    <div class="header">
        <div class="lang-s">
            <button class="l-btn active" id="l-ru" onclick="setLang('ru')">RU</button>
            <button class="l-btn" id="l-tj" onclick="setLang('tj')">TJ</button>
            <button class="l-btn" id="l-en" onclick="setLang('en')">EN</button>
            <button class="l-btn" onclick="toggleTheme()" style="margin-left:8px; background:#475569">üåì</button>
        </div>
        <button id="btn-exit" onclick="location.reload()" style="background:#ef4444; color:#fff; border:none; padding:6px 12px; border-radius:6px; font-weight:bold; cursor:pointer">–í–´–•–û–î</button>
    </div>

    <div class="controls">
        <input type="text" id="nw" class="txt-in" placeholder="–ò–º—è –º–∞—Å—Ç–µ—Ä–∞">
        <button onclick="addW()" id="btn-add" style="background:var(--p); color:#fff; border:none; padding:10px 18px; border-radius:6px; font-weight:bold">OK</button>
        <button onclick="genPDF()" style="background:#fff; color:#000; border:none; padding:10px 15px; border-radius:6px; font-weight:bold">PDF</button>
    </div>
    
    <div class="controls" style="padding-top:0">
        <select id="mS" onchange="render()" style="flex:1; background:var(--card); color:var(--txt); border:1px solid var(--brd); padding:8px; border-radius:6px;"></select>
        <select id="yS" onchange="render()" style="flex:1; background:var(--card); color:var(--txt); border:1px solid var(--brd); padding:8px; border-radius:6px;"></select>
    </div>

    <div class="view">
        <table>
            <thead>
                <tr id="hRow">
                    <th class="cw" id="th-m">–ú–ê–°–¢–ï–†</th>
                    <th class="ct" id="th-t">–ò–¢–û–ì–û</th>
                </tr>
            </thead>
            <tbody id="tBody"></tbody>
        </table>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyBwc9X7c_8UHCb1KlKBLzwbBWHlf22s7a8", authDomain: "dizel-8f122.firebaseapp.com", projectId: "dizel-8f122", storageBucket: "dizel-8f122.firebasestorage.app", messagingSenderId: "648148623489", appId: "1:648148623489:web:193a3b9df407c5babfed80" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    let mode = 'local', userUid = 'local_user', pinCode = null, workers = [], curL = 'ru';

    const dict = {
        ru: { m: "–ú–ê–°–¢–ï–†", t: "–ò–¢–û–ì–û", h: "–ß–∞—Å—ã", r: "–°—Ç–∞–≤–∫–∞", ph: "–ò–º—è –º–∞—Å—Ç–µ—Ä–∞", exit: "–í–´–•–û–î", pinT: "–í–≤–µ–¥–∏—Ç–µ PIN", pinN: "–ü—Ä–∏–¥—É–º–∞–π—Ç–µ PIN", enter: "–í–•–û–î", adv: "–ê–≤–∞–Ω—Å:", qh: "–ß–∞—Å—ã (0-24):", mo: ["–Ø–Ω–≤","–§–µ–≤","–ú–∞—Ä","–ê–ø—Ä","–ú–∞–π","–ò—é–Ω","–ò—é–ª","–ê–≤–≥","–°–µ–Ω","–û–∫—Ç","–ù–æ—è","–î–µ–∫"] },
        tj: { m: "–£–°–¢–û", t: "“∂–ê–™–ú", h: "–°–æ–∞—Ç", r: "–ù–∞—Ä—Ö", ph: "–ù–æ–º–∏ —É—Å—Ç–æ", exit: "–•–£–†–£“∂", pinT: "–†–∞–º–∑—Ä–æ –Ω–∞–≤–∏—Å–µ–¥", pinN: "–†–∞–º–∑–∏ –Ω–∞–≤", enter: "–í–û–†–£–î", adv: "–ê–≤–∞–Ω—Å:", qh: "–°–æ–∞—Ç (0-24):", mo: ["–Ø–Ω–≤","–§–µ–≤","–ú–∞—Ä","–ê–ø—Ä","–ú–∞–π","–ò—é–Ω","–ò—é–ª","–ê–≤–≥","–°–µ–Ω","–û–∫—Ç","–ù–æ—è","–î–µ–∫"] },
        en: { m: "MASTER", t: "TOTAL", h: "Hrs", r: "Rate", ph: "Master Name", exit: "EXIT", pinT: "Enter PIN", pinN: "Create PIN", enter: "LOGIN", adv: "Adv:", qh: "Hours (0-24):", mo: ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"] }
    };

    window.toggleTheme = () => document.getElementById('mainBody').classList.toggle('light');
    window.fN = (n) => Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    window.tr = (s) => {
        const map = {'–∞':'a','–±':'b','–≤':'v','–≥':'g','–¥':'d','–µ':'e','—ë':'yo','–∂':'zh','–∑':'z','–∏':'i','–π':'j','–∫':'k','–ª':'l','–º':'m','–Ω':'n','–æ':'o','–ø':'p','—Ä':'r','—Å':'s','—Ç':'t','—É':'u','—Ñ':'f','—Ö':'kh','—Ü':'ts','—á':'ch','—à':'sh','—â':'sch','—ã':'y','—ç':'e','—é':'yu','—è':'ya','“∑':'j','“õ':'q','“≥':'h','”Ø':'u','“ì':'gh'};
        return s.toLowerCase().split('').map(c => map[c] || c).join('').toUpperCase();
    };

    window.authLocal = () => { mode = 'local'; checkPinSetup(); }
    document.getElementById('btn-google').onclick = () => signInWithPopup(auth, provider).then(r => { mode = 'cloud'; userUid = r.user.uid; localStorage.setItem('user_mode', 'cloud'); localStorage.setItem('user_uid', r.user.uid); checkPinSetup(); });

    async function checkPinSetup() {
        if(mode === 'local') pinCode = localStorage.getItem('mp_pin');
        else { const ds = await getDoc(doc(db, "users", userUid)); if(ds.exists()) pinCode = ds.data().pin; }
        document.getElementById('screen-login').classList.add('hidden');
        document.getElementById('screen-pin').classList.remove('hidden');
        document.getElementById('pin-title').innerText = pinCode ? dict[curL].pinT : dict[curL].pinN;
    }

    window.checkPin = async function() {
        const v = document.getElementById('pin-input').value;
        if(!pinCode) { pinCode = v; if(mode==='local') localStorage.setItem('mp_pin',v); else await setDoc(doc(db,"users",userUid),{pin:v}); loadData(); }
        else if(v === pinCode) loadData(); else alert("Error!");
    }

    async function loadData() {
        document.getElementById('screen-pin').classList.add('hidden');
        document.getElementById('screen-app').classList.remove('hidden');
        if(mode === 'local') workers = JSON.parse(localStorage.getItem('mp_data')) || [];
        else { const ds = await getDoc(doc(db,"data",userUid)); if(ds.exists()) workers = ds.data().w || []; }
        render();
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    async function autoLogin() {
        const savedMode = localStorage.getItem('user_mode');
        const savedUid = localStorage.getItem('user_uid');
        
        if(savedMode === 'local') {
            mode = 'local';
            if(localStorage.getItem('mp_pin')) {
                document.getElementById('screen-login').classList.add('hidden');
                document.getElementById('screen-pin').classList.remove('hidden');
                document.getElementById('pin-title').innerText = dict[curL].pinT;
                pinCode = localStorage.getItem('mp_pin');
            }
        } else if(savedMode === 'cloud' && savedUid) {
            mode = 'cloud';
            userUid = savedUid;
            if(localStorage.getItem('mp_pin')) {
                document.getElementById('screen-login').classList.add('hidden');
                document.getElementById('screen-pin').classList.remove('hidden');
                document.getElementById('pin-title').innerText = dict[curL].pinT;
                pinCode = localStorage.getItem('mp_pin');
            }
        }
    }

    window.setLang = (l) => {
        curL = l;
        document.querySelectorAll('.l-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('l-'+l).classList.add('active');
        document.getElementById('th-m').innerText = dict[l].m;
        document.getElementById('th-t').innerText = dict[l].t;
        document.getElementById('nw').placeholder = dict[l].ph;
        document.getElementById('btn-exit').innerText = dict[l].exit;
        document.getElementById('btn-login-text').innerText = dict[l].enter;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Å—è—Ü—ã
        const mS = document.getElementById('mS');
        const sel = mS.value;
        mS.innerHTML = '';
        dict[l].mo.forEach((m,i)=>mS.add(new Option(m,i,false,i===parseInt(sel||new Date().getMonth()))));
        render();
    }

    window.addW = () => {
        let n = document.getElementById('nw').value.trim();
        if(n) { workers.push({n:n, r:170, d:{}}); saveData(); render(); document.getElementById('nw').value=''; }
    }

    function render() {
        const y=yS.value, m=mS.value, days=new Date(y, parseInt(m)+1, 0).getDate();
        const hr = document.getElementById('hRow');
        while(hr.children.length > 2) hr.removeChild(hr.children[1]);
        for(let d=1; d<=days; d++) { let th = document.createElement('th'); th.className='cd'; th.innerText=d; hr.insertBefore(th, hr.children[d]); }
        const tb = document.getElementById('tBody'); tb.innerHTML = '';
        workers.forEach((w, idx) => {
            let total = 0, hours = 0, row = document.createElement('tr');
            let html = `<td class="cw">${w.n}<br><small>${dict[curL].h}: <span id="th_${idx}">0</span></small><br><input type="number" value="${w.r}" onchange="updR(${idx},this.value)"><br><span onclick="delW(${idx})" style="color:#ef4444;cursor:pointer;font-size:9px">–£–î–ê–õ–ò–¢–¨</span></td>`;
            for(let d=1; d<=days; d++) {
                let k=`${y}_${m}_${d}`, h=w.d[k]?.h||0, a=w.d[k]?.a||0;
                hours+=h; total+=(h*(w.r/8))-a;
                html += `<td class="cd">
                    <div class="sq-h ${h==8?'on':''}" onclick="setH(${idx},'${k}',8)" oncontextmenu="setCus(event,${idx},'${k}')">${(h>0&&h!=8)?h:''}</div>
                    <div class="sq-a ${a>0?'on':''}" onclick="setA(${idx},'${k}')">${a>0?a:'$'}</div>
                </td>`;
            }
            html += `<td class="ct">${fN(total)}</td>`; row.innerHTML = html; tb.appendChild(row);
            setTimeout(() => { document.getElementById(`th_${idx}`).innerText = hours; }, 0);
        });
    }

    window.saveData = async () => { if(mode==='local') localStorage.setItem('mp_data',JSON.stringify(workers)); else await setDoc(doc(db,"data",userUid),{w:workers}); }
    window.updR = (i,v) => { workers[i].r = v; saveData(); render(); }
    window.delW = (i) => { if(confirm('–£–¥–∞–ª–∏—Ç—å?')) { workers.splice(i,1); saveData(); render(); } }
    window.setH = (i,k,v) => { if(!workers[i].d[k]) workers[i].d[k]={}; workers[i].d[k].h=(workers[i].d[k].h===8?0:8); saveData(); render(); }
    
    // –í—ã–±–æ—Ä —á–∞—Å–æ–≤ —á–µ—Ä–µ–∑ –ø—Ä–∞–≤—É—é –∫–Ω–æ–ø–∫—É
    window.setCus = (e,i,k) => { 
        e.preventDefault(); 
        let v = prompt(dict[curL].qh); 
        if(v !== null) { 
            if(!workers[i].d[k]) workers[i].d[k]={}; 
            workers[i].d[k].h = parseInt(v) || 0; 
            saveData(); 
            render(); 
        } 
    }
    
    window.setA = (i,k) => { let v=prompt(dict[curL].adv); if(v!==null){ if(!workers[i].d[k])workers[i].d[k]={}; workers[i].d[k].a=parseFloat(v)||0; saveData(); render(); } }

    window.genPDF = () => {
        const docP = new jspdf.jsPDF();
        docP.text("DIESEL CENTER REPORT", 105, 10, {align:"center"});
        let rows = workers.map(w => {
            let t=0, h_sum=0; for(let k in w.d){ h_sum+=w.d[k].h||0; t+=( (w.d[k].h||0)*(w.r/8) )-(w.d[k].a||0); }
            return [tr(w.n), h_sum, fN(t) + " TJS"];
        });
        docP.autoTable({ head: [['Master', 'Hours', 'Total']], body: rows, startY: 20 });
        docP.save("Report.pdf");
    }

    const mS=document.getElementById('mS'), yS=document.getElementById('yS');
    for(let y=2025;y<=2028;y++) yS.add(new Option(y,y,false,y===new Date().getFullYear()));
    setLang('ru');
    autoLogin();
</script>
</body>
</html>